<!DOCTYPE html>
<html lang="en-us"
  dir="ltr">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">








    


   
    <link rel="canonical" href="/posts/net/so-priority-cmsg/" />
<meta name="google-site-verification" content="2P_FxaDVXfb6cdRTwbSUgI0pq98IOMy5K-l0kEDTI-E" />






<link rel="icon" type="image/ico" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

<meta name="description" content=""/>



<title>
    
    Per-packet SO_PRIORITY socket API | Ferenc Fejes technical blog
    
</title>

<link rel="canonical" href="/posts/net/so-priority-cmsg/"/>

<meta property="og:url" content="/posts/net/so-priority-cmsg/">
  <meta property="og:site_name" content="Ferenc Fejes technical blog">
  <meta property="og:title" content="Per-packet SO_PRIORITY socket API">
  <meta property="og:description" content="How to set priority metadata for individual packets.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-04T10:00:00+00:00">
    <meta property="article:modified_time" content="2025-05-04T10:00:00+00:00">












<link rel="stylesheet" href="/assets/combined.min.ba8580b62aaae86e67e95977ac83a33f1d4e6c316fae799ae5bbe1b621fcc1a7.css" media="all">















    




</head>







<body class="auto">

  <div class="content">
    <header>
      

<div class="header">

    

</div>

    </header>

    <main class="main">
      




<div class="breadcrumbs"><a href="/">Home</a><span class="breadcrumbs-separator">/</span><a href="/posts/">Posts</a><span class="breadcrumbs-separator">/</span>
        <a href="/posts/net/so-priority-cmsg/">Per-packet SO_PRIORITY socket API</a></div>


<div >
  <article>
    <header class="single-intro-container">
        
        <h1 class="single-title">Per-packet SO_PRIORITY socket API</h1>
        <p class="single-summary">How to set priority metadata for individual packets.</p>
    
        <p class="single-readtime">
          <time datetime="2025-05-04T10:00:00&#43;00:00">May 4, 2025</time>
        </p>
    </header>
    
    <div class="single-content">
      <h1 class="heading" id="intro">
  Intro
  <a class="anchor" href="#intro">#</a>
</h1>
<p>The Qdisc subsystem of the Linux kernel allows us to configure network QoS-related mechanisms.
There are various Qdiscs that implement simple tri-band priority queueing, and more advanced ones such as HTB trees.
Many of these Qdiscs (e.g.: <code>fq</code>, <code>ets</code>, <code>mqprio</code>, <code>fq_codel</code>, etc.) rely on packet priority in their decision making.
Prior to Linux 6.14, there was no socket API for setting this priority for individual packets.
With Linux 6.14, an API was introduced to allow the application to set or receive this value with an ancillary message.</p>
<h1 class="heading" id="brief-history">
  Brief history
  <a class="anchor" href="#brief-history">#</a>
</h1>
<p>The central unit of packet processing in the Linux network stack is the <code>struct sk_buff</code> (<code>skb</code> for short).
In addition to the sent/received data, it contains many internal metadata fields.
One such <a href="https://elixir.bootlin.com/linux/v6.14.5/source/include/linux/skbuff.h#L1036">metadata</a> is <code>skb-&gt;priority</code>, which was introduced with Linux 0.98 in 1992.
In addition to the field, it&rsquo;s userspace API was also introduced, the <code>SO_PRIORITY</code> option to <code>setsockopt</code>.
This option allows the application to set the priority of the socket.
Then every packet sent on the socket inherited this value, which was used by the IP layer.</p>
<p>Originally, the sole purpose of this metadata was to set the <em>Type of Service</em> field of the IPv4 header.
Later, it was used extensively by many Qdiscs to implement packet prioritization.
In addition, NIC drivers used it for VLAN priority tagging and it&rsquo;s offload.</p>
<h1 class="heading" id="limitation-of-the-per-socket-approach">
  Limitation of the per-socket approach
  <a class="anchor" href="#limitation-of-the-per-socket-approach">#</a>
</h1>
<p>As an endpoint application, the priority to socket mapping makes sense.
However, Linux can be used as a VPN gateway, proxy, or software switch (among many other things).
In such use cases, we might have a userspace application that multiplexes packets into a tunnel.</p>
<p>For example, a VPN gateway opens a socket that represents the tunneling device.
The packets are received with different priorities, set by their originating socket or some packet filtering mechanism.
The VPN application also has a socket representing the tunnel interface.
But what would be the priority set for this tunnel socket?
Whatever the application sets, it will mask the original priority of the packet.
A more flexible approach is required: set priority on a per-packet basis on the same tunnel socket.</p>
<h1 class="heading" id="the-per-packet-cmsg-api">
  The per-packet CMSG API
  <a class="anchor" href="#the-per-packet-cmsg-api">#</a>
</h1>
<p>Per-packet metadata is not new to Linux.
The API for it is called ancillary or aux message, sometimes referred to as out-of-band control message.
Let&rsquo;s stick with the control message, or CMSG for short.
It is used to set fragmentation, traffic class, hop limit, and other options.
For a comprehensive example, see the <code>cmsg_sender.c</code> <a href="https://elixir.bootlin.com/linux/v6.14.5/source/tools/testing/selftests/net/cmsg_sender.c">selftest in the source tree</a>.</p>
<p>The new CMSG options introduced in Linux 6.14 are <code>SO_PRIORITY</code> and <code>SO_RCVPRIORITY</code>.
The priority metadata is 32 bits long and unsigned.
Without <code>CAP_NET_ADMIN</code> only values from 0 to 6 are accepted.
The following C code snippet gives an example of how to use this.
Unfortunately, due to the nature of the C network API, much of the code is boilerplate.
To reduce the length, the error handling is omitted.
The important part is where we set the <code>SO_PRIORITY</code> type and it&rsquo;s value.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#888;font-weight:bold">#include</span> <span style="color:#888;font-weight:bold">&lt;sys/socket.h&gt;</span><span style="color:#888;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-weight:bold">#include</span> <span style="color:#888;font-weight:bold">&lt;netinet/in.h&gt;</span><span style="color:#888;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-weight:bold">#include</span> <span style="color:#888;font-weight:bold">&lt;arpa/inet.h&gt;</span><span style="color:#888;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-weight:bold">#include</span> <span style="color:#888;font-weight:bold">&lt;unistd.h&gt;</span><span style="color:#888;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-weight:bold">#include</span> <span style="color:#888;font-weight:bold">&lt;string.h&gt;</span><span style="color:#888;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">int</span> <span style="color:#666;font-weight:bold;font-style:italic">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">char</span> *data = <span style="color:#666;font-style:italic">&#34;Data to send&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">const</span> <span style="font-weight:bold;text-decoration:underline">size_t</span> clen = <span style="font-weight:bold;text-decoration:underline">sizeof</span>(<span style="font-weight:bold;text-decoration:underline">unsigned</span> <span style="font-weight:bold;text-decoration:underline">int</span>);
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">char</span> cbuf[<span style="color:#666;font-weight:bold;font-style:italic">CMSG_SPACE</span>(clen)];
</span></span><span style="display:flex;"><span>    <span style="color:#666;font-weight:bold;font-style:italic">memset</span>(cbuf, 0, clen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">struct</span> iovec iov = {
</span></span><span style="display:flex;"><span>        .iov_base = data,
</span></span><span style="display:flex;"><span>        .iov_len = <span style="color:#666;font-weight:bold;font-style:italic">strlen</span>(data),
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">struct</span> sockaddr_in destionation = {
</span></span><span style="display:flex;"><span>        AF_INET, <span style="color:#666;font-weight:bold;font-style:italic">htons</span>(5555),
</span></span><span style="display:flex;"><span>        .sin_addr.s_addr = <span style="color:#666;font-weight:bold;font-style:italic">inet_addr</span>(<span style="color:#666;font-style:italic">&#34;127.0.0.1&#34;</span>)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">struct</span> msghdr msg = {
</span></span><span style="display:flex;"><span>        .msg_name = &amp;destionation,
</span></span><span style="display:flex;"><span>        .msg_namelen = <span style="font-weight:bold;text-decoration:underline">sizeof</span>(destionation),
</span></span><span style="display:flex;"><span>        .msg_iov = &amp;iov,
</span></span><span style="display:flex;"><span>        .msg_iovlen = 1,
</span></span><span style="display:flex;"><span>        .msg_control = cbuf,
</span></span><span style="display:flex;"><span>        .msg_controllen = <span style="color:#666;font-weight:bold;font-style:italic">CMSG_SPACE</span>(clen)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">struct</span> cmsghdr *cmsg = <span style="color:#666;font-weight:bold;font-style:italic">CMSG_FIRSTHDR</span>(&amp;msg);
</span></span><span style="display:flex;"><span>    *cmsg = (<span style="font-weight:bold;text-decoration:underline">struct</span> cmsghdr) {
</span></span><span style="display:flex;"><span>        .cmsg_level = SOL_SOCKET,
</span></span><span style="display:flex;"><span>        .cmsg_type = SO_PRIORITY, <span style="color:#888;font-style:italic">// !
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>        .cmsg_len = <span style="color:#666;font-weight:bold;font-style:italic">CMSG_LEN</span>(clen)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">unsigned</span> <span style="font-weight:bold;text-decoration:underline">int</span> *priority = (<span style="font-weight:bold;text-decoration:underline">unsigned</span> <span style="font-weight:bold;text-decoration:underline">int</span> *) <span style="color:#666;font-weight:bold;font-style:italic">CMSG_DATA</span>(cmsg);
</span></span><span style="display:flex;"><span>    *priority = 987; <span style="color:#888;font-style:italic">// !
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">int</span> sk = <span style="color:#666;font-weight:bold;font-style:italic">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);
</span></span><span style="display:flex;"><span>    <span style="color:#666;font-weight:bold;font-style:italic">sendmsg</span>(sk, &amp;msg, 0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#666;font-weight:bold;font-style:italic">close</span>(sk);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>With Linux 6.14 and above this code send a UDP packet on loopback and instruct the kernel to set <code>skb-&gt;priority</code> to 987.
<strong>Important</strong> to execute it as root or with <code>CAP_NET_ADMIN</code> capability.</p>
<h1 class="heading" id="workarounds-for-older-kernels">
  Workarounds for older kernels
  <a class="anchor" href="#workarounds-for-older-kernels">#</a>
</h1>
<p>Unfortunately there are no clean way to get this behavior on older kernels.
Some workarounds what I used before:</p>
<ol>
<li>Set <code>SO_MARK</code> per-packet and copy the value with an eBPF tc program from <code>skb-&gt;mark</code> to <code>skb-&gt;priority</code> before Qdisc processing.</li>
<li>Open a new socket for each priority for the same destionation.</li>
<li>Very fragile: use <code>setsockopt</code> to change the priority before each send.</li>
</ol>

    </div>
  </article>

  

  

  
  

<div class="single-pagination">
    <hr />

    <div class="flexnowrap">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/posts/net/scaling-iperf/">
                        Thousand TCP flows with iperf
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


    </main>
  </div>

  
  





    




  <footer>
    

    
    





    




    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    


  </footer>

  
</body>

<script src="/js/theme-switch.js"></script>
<script defer src="/js/copy-code.js"></script>
</html>
